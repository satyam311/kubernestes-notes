# Persistent Volumes (PV), Persistent Volume Claims (PVC), and Storage Classes (SC)

### 1. Why We Need PV & PVC in Kubernetes

By default, data stored inside a Pod is ephemeral — it gets deleted when the Pod dies or reschedules.
But many applications (like databases, queues, CMS, etc.) need persistent storage — data that survives Pod restarts.
Kubernetes provides Persistent Volumes (PVs) and Persistent Volume Claims (PVCs) to manage storage independently of Pods and Nodes.

### 2. Persistent Volume (PV)

A PersistentVolume (PV) is a piece of storage in the cluster that has been provisioned by an admin or dynamically created using a StorageClass.
It’s a cluster resource, just like a Node is a cluster resource.

Characteristics : 
Has its own lifecycle independent of any Pod.
Can be backed by various storage types:

- Local disk
- -NFS
- AWS EBS
- GCP Persistent Disk
- Azure Disk, etc.

```bash
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/data
```

| Field                             | Description                                                                                                                   |
| --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| **capacity**                      | Size of the storage (e.g., 1Gi).                                                                                              |
| **accessModes**                   | Defines how a PV can be mounted.                                                                                              |
| **storageClassName**              | Matches with PVC’s storage class.                                                                                             |
| **persistentVolumeReclaimPolicy** | What happens when PVC is deleted: <br> - `Retain` → keeps data <br> - `Delete` → deletes volume <br> - `Recycle` → deprecated |
| **hostPath/NFS/etc.**             | Defines actual storage backend.                                                                                               |


### 3. Persistent Volume Claim (PVC)

A PersistentVolumeClaim (PVC) is a request for storage by a user or Pod.
PVCs are to Pods what PVs are to Nodes — they claim storage resources.

```bash 
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
  storageClassName: manual
```

| Field                          | Description                                  |
| ------------------------------ | -------------------------------------------- |
| **accessModes**                | Must match the PV’s mode.                    |
| **resources.requests.storage** | Amount of storage needed.                    |
| **storageClassName**           | Matches PV or triggers dynamic provisioning. |


- When PVC is created, Kubernetes looks for a matching PV (same storage class, capacity, and access mode).
- If found → PV is bound to PVC (status: Bound).
- Pod then uses PVC, not PV directly.

### 4. Access Modes

| Access Mode                 | Description                            | Typical Use Case          |
| --------------------------- | -------------------------------------- | ------------------------- |
| **ReadWriteOnce (RWO)**     | Mounted as read-write by a single node | Databases                 |
| **ReadOnlyMany (ROX)**      | Mounted read-only by many nodes        | Shared config files       |
| **ReadWriteMany (RWX)**     | Mounted read-write by many nodes       | Shared storage like NFS   |
| **ReadWriteOncePod (RWOP)** | Mounted by only one Pod (K8s 1.22+)    | Strict single access apps |



### 5. StorageClass (SC)

A StorageClass provides a way for admins to describe the “classes” of storage they offer (like “fast SSD” or “slow HDD”).
It also enables dynamic provisioning of PVs.

Instead of pre-creating PVs, Kubernetes can automatically create one when a PVC is requested.

```bash 
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
reclaimPolicy: Delete
volumeBindingMode: Immediate
```
| Field                 | Description                                                                                                                    |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| **provisioner**       | Driver that provisions storage (AWS, GCP, Azure, CSI, etc.)                                                                    |
| **parameters**        | Configuration for that provisioner.                                                                                            |
| **reclaimPolicy**     | What to do with the volume after PVC is deleted (`Retain`, `Delete`).                                                          |
| **volumeBindingMode** | - `Immediate`: binds instantly. <br> - `WaitForFirstConsumer`: binds only when a Pod uses it (prevents wrong zone allocation). |

### 6. Lifecycle of PV-PVC

   - Admin creates PV or defines StorageClass.
   - User creates PVC.
   - Kubernetes matches PVC with available PV.
   - PVC binds to PV → Bound state.
   - Pod mounts the PVC.
   - When Pod deleted → PVC may remain.
   - When PVC deleted → PV released or reclaimed (based on policy).


### 7. Pod Example Using PVC

 ```
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
spec:
  containers:
    - name: myapp
      image: nginx
      volumeMounts:
        - mountPath: "/usr/share/nginx/html"
          name: my-storage
  volumes:
    - name: my-storage
      persistentVolumeClaim:
        claimName: my-pvc
   ```

### Mind Map : 

```
┌──────────────────────────────┐
│          Cluster             │
│ ┌──────────────┐             │
│ │ StorageClass │  <-- defines provisioner, policy
│ └──────┬───────┘
│        │ dynamic provisioning
│ ┌──────▼──────┐   ┌──────────────┐
│ │ Persistent  │   │ Persistent   │
│ │ Volume (PV) │←──│ VolumeClaim │←── Pod
│ └──────────────┘   └──────────────┘
│         ^ binding
│         │
│    Physical Storage
│ (AWS EBS, NFS, hostPath)
└──────────────────────────────┘
```
After doing all the config, we can exec into the pod and create a file under the path ```/usr/share/nginx/html```
```
kubectl exec -it myapp-pod -- bash
cd /usr/share/nginx/html
echo "Hello from inside the pod" > pod_test.html
```

if your cluster is multi node, then we need to log into to each node to check if you are able to find the above file or not.
```
docker exec -it multi-node-cluster-worker bash 
cd /mnt/data
```

---
******* **** *******
---

# How to perform Dynamic provisioning on kind(using local provisioner) 
To practice StorageClass + dynamic provisioning (so PVCs automatically create PVs), install a local provisioner such as rancher/local-path-provisioner (a common choice for local clusters like kind). I’ll give the steps conceptually and commands you can run

Quick summary:
- Install the local-path provisioner (creates a StorageClass e.g. local-path).
- Create a PVC (no preexisting PV needed) referencing that StorageClass → PVC will be Bound automatically.

1. Install the local-path provisioner into your cluster.
   github repo : https://github.com/rancher/local-path-provisioner

2. Confirm the StorageClass appears:

```
kubectl get storageclass
# look for something like "local-path" or "standard" created by the provisioner
kubectl describe storageclass local-path
```
3. Create a PVC that uses the dynamic StorageClass (pvc-dyn.yaml):

```
# pvc-dyn.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-dynamic-1
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-path   # change to the name shown in your cluster

```
4. Apply PVC and watch it get provisioned:
```
kubectl apply -f pvc-dyn.yaml
kubectl get pvc
kubectl get pv
# You should see a PV created automatically and the PVC status Bound.
```
5. Create pod
```
apiVersion: v1 
kind: Pod
metadata:
  name: pvc-dynamic
spec:
  containers:
  - name: pod-app
    image: nginx
    volumeMounts:
    - name: mypvc 
      mountPath: /usr/share/nginx/html 
  volumes:
  - name: mypvc
    persistentVolumeClaim:
      claimName: pvc-dynamic
```

----- Extra notes ---------------

As we know in case of dynamic we need a provision like aws ebs, a veeramlaa used CSI in a project, so we download a local provision like rancher to make the thing but I found a video, it said if we set : provisioner: kubernetes.io/no-provisioner, intead of dynamic, we need to created pv manually.


https://www.youtube.com/watch?v=qLL5wf0ShZY&list=PLl4APkPHzsUUOkOv3i62UidrLmSB8DcGC&index=47 => 13:50


```bash 
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/no-provisioner 
parameters:
  type: gp2
reclaimPolicy: Delete
volumeBindingMode: Immediate
```



